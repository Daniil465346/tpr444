<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инвестиции</title>
    <style>
        body {
            font-family: Arial;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }

        .section {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            box-sizing: border-box;
            border: 1px solid #ddd;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

            button:hover {
                background: #0056b3;
            }

        .result {
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
        }

        .success {
            background: #d4edda;
        }

        .error {
            background: #f8d7da;
        }

        .trigger {
            background: #fff3cd;
            margin: 5px 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1> Управление инвестициями</h1>

    <div class="section">
        <h3> Калькулятор</h3>
        <select id="calcSecurityId" onchange="updatePrices()">
            <option value="">Выберите бумагу</option>
        </select>
        <input type="number" id="calcQuantity" placeholder="Количество" value="10">
        <input type="number" id="calcCurrentPrice" placeholder="Текущая цена" step="0.01" readonly>
        <input type="number" id="calcCommission" placeholder="Комиссия" value="5.00" step="0.01">
        <button onclick="calculate()">Рассчитать</button>
        <div id="calcResult" class="result"></div>
    </div>

    <div class="section">
        <h3>Новая операция</h3>
        <select id="opSecurityId">
            <option value="">Выберите бумагу</option>
        </select>
        <input type="number" id="opQuantity" placeholder="Количество" value="10">
        <input type="number" id="opPrice" placeholder="Цена покупки" step="0.01">
        <input type="number" id="opCommission" placeholder="Комиссия" value="5.00" step="0.01">
        <input type="number" id="opTargetPrice" placeholder="Цена для выкупа" step="0.01">
        <button onclick="addOperation()">Добавить</button>
        <div id="opResult" class="result"></div>
    </div>

    <div class="section">
        <h3> Активные ордеры</h3>
        <button onclick="getActiveTriggers()">Обновить</button>
        <div id="triggersResult" class="result"></div>
    </div>

    <div class="section">
        <h3> Данные</h3>
        <button onclick="getOperations()">История операций</button>
    </div>

    <script>
        const API_BASE = `${window.location.origin}/api/investment`;
        let securities = [];

        
        async function loadSecurities() {
            try {
                const response = await fetch(`${API_BASE}/securities`);
                securities = await response.json();

                securities.forEach(security => {
                    const option = `<option value="${security.id}">${security.ticker} - $${security.currentPrice}</option>`;
                    document.getElementById('calcSecurityId').innerHTML += option;
                    document.getElementById('opSecurityId').innerHTML += option;
                });
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        
        function updatePrices() {
            const security = securities.find(s => s.id == document.getElementById('calcSecurityId').value);
            if (security) {
                document.getElementById('calcCurrentPrice').value = security.currentPrice;
                document.getElementById('opPrice').value = security.currentPrice;
                document.getElementById('opTargetPrice').value = (security.currentPrice * 0.9).toFixed(2);
            }
        }

        
        async function apiCall(url, options, resultId) {
            try {
                const response = await fetch(url, options);
                const result = await response.json();
                showResult(resultId, result.message || JSON.stringify(result, null, 2), true);
            } catch (error) {
                showResult(resultId, 'Ошибка: ' + error.message, false);
            }
        }

        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        
        async function calculate() {
            const securityId = document.getElementById('calcSecurityId').value;
            const quantity = document.getElementById('calcQuantity').value;
            const price = document.getElementById('calcCurrentPrice').value;
            const commission = document.getElementById('calcCommission').value;

            if (!securityId) return showResult('calcResult', 'Выберите бумагу', false);

            try {
                const response = await fetch(`${API_BASE}/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        securityId: parseInt(securityId),
                        quantity: parseInt(quantity),
                        purchasePricePerShare: parseFloat(price),
                        commission: parseFloat(commission)
                    })
                });

                const result = await response.json();
                const security = securities.find(s => s.id == securityId);

                document.getElementById('calcResult').innerHTML =
                    `<strong>Итог ${security.ticker}: $${result.totalCost}</strong><br>
             `;
                document.getElementById('calcResult').className = 'result success';

            } catch (error) {
                document.getElementById('calcResult').textContent = 'Ошибка: ' + error.message;
                document.getElementById('calcResult').className = 'result error';
            }
        }

        
        async function addOperation() {
            const securityId = document.getElementById('opSecurityId').value;
            const quantity = document.getElementById('opQuantity').value;
            const price = document.getElementById('opPrice').value;
            const commission = document.getElementById('opCommission').value;
            const targetPrice = document.getElementById('opTargetPrice').value;

            if (!securityId) return showResult('opResult', 'Выберите бумагу', false);

            const operation = {
                securityId: parseInt(securityId),
                quantity: parseInt(quantity),
                purchasePricePerShare: parseFloat(price),
                commission: parseFloat(commission),
                targetBuyPrice: parseFloat(targetPrice)
            };

            apiCall(`${API_BASE}/operation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(operation)
            }, 'opResult');
        }

        
        async function getActiveTriggers() {
            try {
                const response = await fetch(`${API_BASE}/active-triggers`);
                const triggers = await response.json();

                const result = document.getElementById('triggersResult');
                result.innerHTML = triggers.length ?
                    triggers.map(t => `<div class="trigger">${t.message}<br><small>Цель: $${t.targetPrice} | Текущая: $${t.currentPrice}</small></div>`).join('') :
                    'Нет активных триггеров';
            } catch (error) {
                showResult('triggersResult', 'Ошибка: ' + error.message, false);
            }
        }

        
        async function getOperations() {
            try {
                const response = await fetch(`${API_BASE}/operations`);
                const data = await response.json();
                alert('История операций:\n' + (data.map(op =>
                    `${op.id}. ${op.securityTicker} - ${op.quantity}шт x $${op.purchasePricePerShare} = $${op.totalCost}` +
                    (op.targetBuyPrice ? ` [Триггер: $${op.targetBuyPrice}]` : '')
                ).join('\n') || 'Нет операций'));
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        
        loadSecurities();
        getActiveTriggers();
    </script>
</body>
</html>